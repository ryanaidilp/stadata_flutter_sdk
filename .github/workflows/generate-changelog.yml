name: Generate Changelog

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+" # for tags like: '1.2.3'
  workflow_dispatch:
    inputs:
      version:
        description: "Version for changelog entry"
        required: true
        type: string
      from_tag:
        description: "Generate changelog from this tag (optional)"
        required: false
        type: string
      include_types:
        description: "Comma-separated commit types to include (feat,fix,docs,etc.)"
        required: false
        type: string
        default: "feat,fix,docs,style,refactor,perf,test,chore,ci,build"
      create_pr:
        description: "Create a pull request with the changelog update"
        required: false
        type: boolean
        default: false

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Determine version and from_tag
        id: version_info
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Extract version from tag
            VERSION="${{ github.ref_name }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            
            # Get previous tag for from_tag
            PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$VERSION$" | head -1)
            echo "from_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          else
            # Use manual inputs
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "from_tag=${{ inputs.from_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: generate
        run: |
          VERSION="${{ steps.version_info.outputs.version }}"
          FROM_TAG="${{ steps.version_info.outputs.from_tag }}"
          TYPES="${{ inputs.include_types || 'feat,fix,docs,style,refactor,perf,test,chore,ci,build' }}"
          
          echo "Generating changelog for version: $VERSION"
          echo "From tag: $FROM_TAG"
          echo "Include types: $TYPES"
          
          # Generate new changelog entry
          python .github/scripts/generate_changelog.py \
            --version "$VERSION" \
            ${FROM_TAG:+--from-tag "$FROM_TAG"} \
            --types "$TYPES" \
            --include-author \
            --output CHANGELOG_NEW.md
          
          # Check if changelog was generated
          if [ -f CHANGELOG_NEW.md ]; then
            echo "changelog_generated=true" >> $GITHUB_OUTPUT
            echo "Generated changelog:"
            cat CHANGELOG_NEW.md
          else
            echo "changelog_generated=false" >> $GITHUB_OUTPUT
            echo "No changelog generated"
          fi

      - name: Update main changelog
        if: steps.generate.outputs.changelog_generated == 'true'
        run: |
          # Create backup of existing changelog
          cp CHANGELOG.md CHANGELOG_BACKUP.md
          
          # Combine new changelog with existing one
          {
            echo "# Change Log"
            echo ""
            cat CHANGELOG_NEW.md
            echo ""
            # Skip the header of the existing changelog and append the rest
            tail -n +3 CHANGELOG.md
          } > CHANGELOG_TEMP.md
          
          # Replace the original changelog
          mv CHANGELOG_TEMP.md CHANGELOG.md
          
          # Clean up
          rm CHANGELOG_NEW.md
          
          echo "Updated CHANGELOG.md successfully"

      - name: Create Pull Request
        if: steps.generate.outputs.changelog_generated == 'true' && (inputs.create_pr == true || github.event_name == 'push')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs(changelog): update for version ${{ steps.version_info.outputs.version }}"
          title: "📝 Update changelog for version ${{ steps.version_info.outputs.version }}"
          body: |
            ## 📝 Changelog Update
            
            This PR updates the changelog for version `${{ steps.version_info.outputs.version }}`.
            
            ### Changes included:
            - Generated from commits since `${{ steps.version_info.outputs.from_tag }}`
            - Includes commit types: `${{ inputs.include_types || 'feat,fix,docs,style,refactor,perf,test,chore,ci,build' }}`
            
            ### Auto-generated content:
            The changelog content was automatically generated from git commits using conventional commit format.
            
            🤖 This PR was created automatically by the changelog generation workflow.
          branch: changelog/v${{ steps.version_info.outputs.version }}
          delete-branch: true
          labels: |
            documentation
            changelog
            automated

      - name: Commit changes directly
        if: steps.generate.outputs.changelog_generated == 'true' && inputs.create_pr != true && github.event_name != 'push'
        run: |
          git add CHANGELOG.md
          git commit -m "docs(changelog): update for version ${{ steps.version_info.outputs.version }}"
          git push origin ${{ github.ref_name }}

      - name: Upload changelog artifact
        if: steps.generate.outputs.changelog_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changelog-v${{ steps.version_info.outputs.version }}
          path: |
            CHANGELOG.md
            CHANGELOG_BACKUP.md
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## 📝 Changelog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **From Tag**: ${{ steps.version_info.outputs.from_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Types**: ${{ inputs.include_types || 'feat,fix,docs,style,refactor,perf,test,chore,ci,build' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated**: ${{ steps.generate.outputs.changelog_generated }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Create PR**: ${{ inputs.create_pr || (github.event_name == 'push') }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.generate.outputs.changelog_generated }}" = "true" ]; then
            echo "✅ Changelog generated successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ No changelog generated" >> $GITHUB_STEP_SUMMARY
          fi